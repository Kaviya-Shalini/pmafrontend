<!-- location.component.html -->
<div class="min-h-screen w-full flex flex-col bg-gradient-to-tr from-indigo-950 via-purple-950 to-pink-950 text-white relative overflow-hidden rounded-3xl p-6">

  <!-- Decorative glows -->
  <div class="absolute top-20 left-10 w-[360px] h-[360px] bg-pink-500 opacity-25 blur-[140px] animate-pulse-slow rounded-full"></div>
  <div class="absolute bottom-20 right-10 w-[360px] h-[360px] bg-indigo-400 opacity-20 blur-[160px] animate-pulse-slow rounded-full"></div>

  <!-- Header -->
  <div class="flex items-center justify-between mb-6 z-10">
    <div>
      <h2 class="text-3xl font-extrabold">Location & Safety</h2>
      <p class="text-sm opacity-80 mt-1">Live location, permanent address, directions & emergency alerts.</p>
    </div>

    <div class="flex items-center gap-3">
      <button class="px-4 py-2 rounded-full bg-white/10 border border-white/10 hover:scale-105 transition"
              (click)="getCurrentLocation()">
        🔁 Refresh Location
      </button>
      <button class="px-4 py-2 rounded-full bg-yellow-400 text-indigo-950 font-semibold hover:scale-105 transition"
              (click)="askToSavePermanent()">
        📍 Save Permanent
      </button>
      <button class="px-4 py-2 rounded-full bg-red-600/90 hover:scale-105 transition shadow-lg"
              (click)="sendDangerAlert()">
        🚨 Danger
      </button>
    </div>
  </div>

  <!-- Main grid -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 z-10">
    <!-- Map card -->
    <div class="lg:col-span-2 bg-white/6 rounded-2xl p-4 shadow-2xl backdrop-blur-md border border-white/8 overflow-hidden">
      <div class="flex justify-between items-start mb-3">
        <h3 class="font-bold">Live Map</h3>
        <div class="text-xs opacity-80">Accuracy: {{ currentAccuracy ? currentAccuracy + ' m' : '-' }}</div>
      </div>

      <div class="rounded-xl overflow-hidden border border-white/6 shadow-inner">
        <!-- iframe map using OpenStreetMap embed -->
        <iframe
          *ngIf="mapSrc"
          [src]="mapSrc | safeUrl"
          class="w-full h-[420px] border-0"
          loading="lazy"
        ></iframe>

        <div *ngIf="!mapSrc" class="h-[420px] flex items-center justify-center text-sm opacity-80">
          Map not ready — allow location permissions.
        </div>
      </div>

      <div class="flex items-center justify-between mt-4">
        <div>
          <p class="text-xs opacity-70">Current coordinates</p>
          <p class="text-sm font-semibold">{{ formatCoords(currentLat, currentLng) }}</p>
        </div>

        <div class="flex gap-3">
          <button class="px-3 py-1 rounded-full bg-white/8 hover:scale-105"
                  (click)="showPermanentOnMap()"
                  [disabled]="!permanentLocation">
            Show Permanent
          </button>
          <button class="px-3 py-1 rounded-full bg-white/8 hover:scale-105"
                  (click)="getDirections()"
                  [disabled]="!permanentLocation || !isAway">
            ➜ Directions to Permanent
          </button>
        </div>
      </div>

      <!-- Away alert -->
      <div *ngIf="isAway && permanentLocation" class="mt-4 p-3 rounded-lg bg-red-900/30 border border-red-700 flex items-center justify-between">
        <div>
          <p class="font-semibold">Status: Away from permanent location</p>
          <p class="text-xs opacity-80">Permanent: {{ formatCoords(permanentLocation.latitude, permanentLocation.longitude) }}</p>
        </div>
        <div class="flex gap-2">
          <button class="px-3 py-1 rounded-full bg-yellow-400 text-indigo-950" (click)="getDirections()">Get Directions</button>
          <button class="px-3 py-1 rounded-full bg-white/6" (click)="sendDangerAlert()">Notify Family</button>
        </div>
      </div>
    </div>

    <!-- Permanent location & controls -->
    <div class="bg-white/6 rounded-2xl p-6 shadow-2xl backdrop-blur-md border border-white/8">
      <h3 class="font-bold mb-2">Permanent Location</h3>

      <div *ngIf="permanentLocation; else noPerm">
        <p class="text-xs opacity-80">Saved at</p>
        <p class="font-semibold">{{ permanentLocation.savedAt | date:'medium' }}</p>
        <p class="mt-3 text-sm">Address: <span class="font-medium">{{ permanentLocation.address || '—' }}</span></p>
        <p class="mt-2 text-sm">Coordinates: <span class="font-medium">{{ formatCoords(permanentLocation.latitude, permanentLocation.longitude) }}</span></p>

        <div class="mt-4 flex gap-3">
          <button class="px-4 py-2 rounded-full bg-yellow-400 text-indigo-950 font-semibold" (click)="startEditPermanent()">Edit</button>
          <button class="px-4 py-2 rounded-full bg-white/8" (click)="showPermanentOnMap()">Center on Map</button>
        </div>
      </div>

      <ng-template #noPerm>
        <p class="text-sm opacity-80">No permanent address saved yet. Save the current location or add a new one.</p>
        <div class="mt-4 flex gap-3">
          <button class="px-4 py-2 rounded-full bg-yellow-400 text-indigo-950 font-semibold" (click)="askToSavePermanent()">Save Current</button>
        </div>
      </ng-template>

      <!-- Edit form -->
      <div *ngIf="editing || showSaveConfirm" class="mt-5 p-4 rounded-xl bg-white/5 border border-white/6">
        <h4 class="font-semibold mb-2">{{ editing ? 'Edit Permanent Location' : 'Save Permanent Location' }}</h4>

        <label class="block text-xs opacity-80 mb-1">Latitude</label>
        <input type="number" [(ngModel)]="editLat" class="w-full mb-2 px-3 py-2 rounded-lg bg-transparent border border-white/8 outline-none" />

        <label class="block text-xs opacity-80 mb-1">Longitude</label>
        <input type="number" [(ngModel)]="editLng" class="w-full mb-2 px-3 py-2 rounded-lg bg-transparent border border-white/8 outline-none" />

        <label class="block text-xs opacity-80 mb-1">Address (optional)</label>
        <input type="text" [(ngModel)]="editAddress" placeholder="e.g., Home — 123, Anna St." class="w-full mb-3 px-3 py-2 rounded-lg bg-transparent border border-white/8 outline-none" />

        <div class="flex gap-2 justify-end">
          <button class="px-3 py-1 rounded-full bg-white/8" (click)="cancelEdit()">Cancel</button>
          <button *ngIf="editing" class="px-3 py-1 rounded-full bg-yellow-400 text-indigo-950" (click)="savePermanentEdit()">Save</button>
          <button *ngIf="!editing" class="px-3 py-1 rounded-full bg-yellow-400 text-indigo-950" (click)="savePermanent()">Save Permanent</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Message / footer -->
  <div class="mt-6 text-sm opacity-90">
    <p *ngIf="message" class="inline-block bg-white/6 px-4 py-2 rounded-lg border border-white/8">{{ message }}</p>
  </div>
</div>
